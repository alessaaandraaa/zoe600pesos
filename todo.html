<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>TODO</title>
</head>
<body>
    <!--
        NOTE: No add task functionality, so using user_id=1 for testing purposes
    -->
    <p>Iloy si cliff</p>
    <h2>Add Task</h2>
    <form id="addTaskForm">
        <input type="text" id="item_name" placeholder="Task name" required>
        <input type="text" id="item_description" placeholder="Task description" required>
        <button type="submit">Add Task</button>
    </form>

    <h1>Commented the delete button bc it actually deletes the tasks lmao</h1>
    <span>
        <button id = "activeTasks">Active Tasks</button>
        <button id = "inactiveTasks">Inactive Tasks</button>
    <span>
    <div class = "active-todo"></div>
    <div class = "inactive-todo"></div>
    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const userId = urlParams.get('user_id');

        $("#activeTasks").click(function(){
            $(".active-todo").show();
            $(".inactive-todo").hide();

            renderTasks("active");
        });
        
        $("#inactiveTasks").click(function(){
            $(".inactive-todo").show();
            $(".active-todo").hide();

            renderTasks("inactive");
        });
        /*
        $(document).on("click", ".delete-task", function () {
            let taskDiv = $(this).parent();  
            let taskId = taskDiv.attr('class');            
            console.log("Deleting task:", taskId);

            deleteTask(taskId);
        }); */

        function renderTasks(status) {
            var xhttp = new XMLHttpRequest();
            const url = `https://todo-list.dcism.org/getItems_action.php?status=${encodeURIComponent(status)}&user_id=${encodeURIComponent(userId)}`; // Change
            xhttp.open("GET", url, true);
            xhttp.send();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    console.log(response);

                    const items = Object.values(response.data || {}); // in case data is empty

                    console.log(items);

                    let todoDiv = document.querySelector(`.${status}-todo`);
                    let ul = document.createElement('ul');

                    todoDiv.innerHTML = '';

                    items.forEach(item => {
                        let task = document.createElement('div');
                        task.className = `${item.item_id}`
                        task.innerHTML = `
                            <h2>${item.item_name}</h2>
                            <p>${item.item_description}</p>
                            <button class = "delete-task">Delete Task</button>
                        `;
                        ul.appendChild(task);
                    });

                    todoDiv.appendChild(ul);
                }
            }
        }

        function deleteTask(id) {
            var xhttp = new XMLHttpRequest();
            // const url = `https://todo-list.dcism.org/deleteItem_action.php?item_id=${encodeURIComponent(id)}`;
            const url = `https://todo-list.dcism.org/getItems_action.php?status=${encodeURIComponent(status)}&user_id=${encodeURIComponent(userId)}&t=${Date.now()}`; // add timestamp to prevent caching
            xhttp.open("GET", url, true);
            xhttp.send();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    console.log(response);

                    renderTasks("active");
                    renderTasks("inactive");
                }
            }
        }

        document.getElementById("addTaskForm").addEventListener("submit", function(e) {
            e.preventDefault();

            const item_name = document.getElementById("item_name").value.trim();
            const item_description = document.getElementById("item_description").value.trim();
            const status = "active";

            if (!item_name || !item_description || !userId) {
                alert("⚠️ Please fill all fields and ensure user_id is set.");
                return;
            }

            // Build URL-encoded form data
            const params = `item_name=${encodeURIComponent(item_name)}&item_description=${encodeURIComponent(item_description)}&user_id=${encodeURIComponent(userId)}&status=${encodeURIComponent(status)}`;

            const xhttp = new XMLHttpRequest();
            xhttp.open("POST", "https://todo-list.dcism.org/addItem_action.php", true);
            xhttp.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

            xhttp.onreadystatechange = function() {
                if (this.readyState === 4) {
                    let response;
                    try {
                        // Strip PHP warnings if they exist
                        const jsonStart = this.responseText.indexOf("{");
                        response = JSON.parse(this.responseText.substring(jsonStart));
                    } catch (err) {
                        console.error("Invalid JSON from server:", this.responseText);
                        alert("❌ Could not parse server response.");
                        return;
                    }

                    if (response.status === 200) {
                        alert("✅ Task added successfully!");
                        document.getElementById("addTaskForm").reset();

                        // Render the new task immediately
                        const newTask = response.data;
                        const todoDiv = document.querySelector(".active-todo");
                        let ul = todoDiv.querySelector("ul");
                        if (!ul) {
                            ul = document.createElement("ul");
                            todoDiv.appendChild(ul);
                        }

                        const taskDiv = document.createElement("div");
                        taskDiv.className = `${newTask.item_id}`;
                        taskDiv.innerHTML = `
                            <h2>${newTask.item_name}</h2>
                            <p>${newTask.item_description}</p>
                            <button class="delete-task">Delete Task</button>
                        `;
                        ul.appendChild(taskDiv);

                    } else {
                        alert("⚠️ Failed to add task: " + response.message);
                    }
                }
            };

            xhttp.send(params);
        });



    </script>

</body>
</html>