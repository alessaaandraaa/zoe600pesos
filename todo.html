<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>TODO</title>
</head>
<body>
    <!--
        NOTE: No add task functionality, so using user_id=1 for testing purposes
    -->
    <p>Iloy si cliff</p>
    <h2>Add Task</h2>
    <form id="addTaskForm" method = "post">
        <input type="text" id="item_name" name = "item_name" placeholder="Task Name" required>
        <input type="text" id="item_description" name = "item_description" placeholder="Task Description" required>
        <button type="submit">Add Task</button>
    </form>

    <h1>Commented the delete button bc it actually deletes the tasks lmao</h1>
    <span>
        <button id = "activeTasks">Active Tasks</button>
        <button id = "inactiveTasks">Inactive Tasks</button>
    <span>
    <div class = "active-todo"></div>
    <div class = "inactive-todo"></div>
    <script>
    
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const userId = urlParams.get('user_id');

        $("#activeTasks").click(function(){
            $(".active-todo").show();
            $(".inactive-todo").hide();

            renderTasks("active");
        });
        
        $("#inactiveTasks").click(function(){
            $(".inactive-todo").show();
            $(".active-todo").hide();

            renderTasks("inactive");
        });

        $("#addTaskForm").on("submit", function(event) {
                event.preventDefault();

                let formData = {};
                new FormData(this).forEach((value, key) => {
                    formData[key] = value;
                });

                formData.user_id = userId;

                let jsonData = JSON.stringify(formData);
                console.log("New Task:", jsonData);

                var xhttp = new XMLHttpRequest();
                const url = `https://todo-list.dcism.org/addItem_action.php`;
                xhttp.open("POST", `${url}`, true);
                console.log("Submitting data...");

                xhttp.onreadystatechange = function() {
                    if (this.readyState === 4) {
                        console.log("Raw signup response:", this.responseText);
                        if (this.status === 200) {
                            try {
                                const response = JSON.parse(this.responseText);
                                console.log("Parsed signup response:", response);
                                alert("Added task");
                            } catch (e) {
                                console.error("Add Task: Could not parse JSON", e);
                            }
                        } else {
                            console.error("Failed to add task", this.status, this.responseText);
                        }
                    }
                };
                xhttp.send(jsonData);
        });
        
        $(document).on("click", ".delete-task", function () {
            let taskDiv = $(this).parent();  
            let taskId = taskDiv.attr('class');            
            console.log("Deleting task:", taskId);

            deleteTask(taskId);
        }); 

        function renderTasks(status) {
            var xhttp = new XMLHttpRequest();
            const url = `https://todo-list.dcism.org/getItems_action.php?status=${encodeURIComponent(status)}&user_id=${encodeURIComponent(userId)}`; // Change
            xhttp.open("GET", url, true);
            xhttp.send();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    console.log(response);

                    const items = Object.values(response.data || {}); // in case data is empty

                    console.log(items);

                    let todoDiv = document.querySelector(`.${status}-todo`);
                    let ul = document.createElement('ul');

                    todoDiv.innerHTML = '';

                    items.forEach(item => {
                        let task = document.createElement('div');
                        task.className = `${item.item_id}`
                        task.innerHTML = `
                            <h2>${item.item_name}</h2>
                            <p>${item.item_description}</p>
                            <button class = "delete-task">Delete Task</button>
                        `;
                        ul.appendChild(task);
                    });

                    todoDiv.appendChild(ul);
                }
            }
        }

        function deleteTask(id) {
            var xhttp = new XMLHttpRequest();
            const url = `https://todo-list.dcism.org/deleteItem_action.php?item_id=${encodeURIComponent(id)}`;
            //const url = `https://todo-list.dcism.org/getItems_action.php?status=${encodeURIComponent(status)}&user_id=${encodeURIComponent(userId)}&t=${Date.now()}`; // add timestamp to prevent caching
            xhttp.open("GET", url, true);
            xhttp.send();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    console.log(response);

                    renderTasks("active");
                    renderTasks("inactive");
                }
            }
        }

    </script>

</body>
</html>