<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <title>TODO</title>
</head>
<body>
    <!--
        NOTE: No add task functionality, so using user_id=1 for testing purposes
    -->
    <p>Iloy si cliff</p>
    <h2>Add Task</h2>
    <form id="addTaskForm" method = "post">
        <input type="text" id="item_name" name = "item_name" placeholder="Task Name" required>
        <input type="text" id="item_description" name = "item_description" placeholder="Task Description" required>
        <button type="submit">Add Task</button>
    </form>

    <span>
        <button id = "activeTasks">Active Tasks</button>
        <button id = "inactiveTasks">Inactive Tasks</button>
    <span>
        
    <div class = "active-todo"></div>
    <div class = "inactive-todo"></div>
    
   
    <div id="editTaskModal">
    <h2>Edit Task</h2>
    <form id="editTaskForm" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc;">
        <input type="text" id="edit_item_name" name="item_name" required>
        <input type="text" id="edit_item_description" name="item_description" required>
        <input type="hidden" id="edit_item_id" name="item_id">
        <button type="submit" id = "task_updat">Update Task</button>
        <button type="button" id="cancelEdit">Cancel</button>
    </form>
    </div>


    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const userId = urlParams.get('user_id');

        // -------- VISIBILITY SCRIPT ------------

        $("#editTaskModal").hide();

        $("#activeTasks").click(function(){
            $(".active-todo").show();
            $(".inactive-todo").hide();

            renderTasks("active");
        });
        
        $("#inactiveTasks").click(function(){
            $(".inactive-todo").show();
            $(".active-todo").hide();

            renderTasks("inactive");
        });

        $(document).on("click", ".edit-task", function() {
            const id = $(this).data("id");
            const name = $(this).data("name");
            const desc = $(this).data("desc");

            $("#edit_item_id").val(id);
            $("#edit_item_name").val(name);
            $("#edit_item_description").val(desc);
            $("#editTaskModal").show();
            $("#editTaskForm").show();
        });

        $("#cancelEdit").click(function() {
            $("#editTask").hide();
            $("#editTaskForm").hide();
        });

        // ------------- ADD TASK -------------

        $("#addTaskForm").on("submit", function(event) {
        event.preventDefault();

            // create javascript object storing the form data
            let formData = {};
            new FormData(this).forEach((value, key) => {
                formData[key] = value;
            });

            formData.user_id = userId;

            let jsonData = JSON.stringify(formData);
            console.log("New Task:", jsonData);

            var xhttp = new XMLHttpRequest();
            const url = `https://todo-list.dcism.org/addItem_action.php`;
            xhttp.open("POST", `${url}`, true);
            console.log("Submitting data...");

            xhttp.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log("Raw signup response:", this.responseText);
                    if (this.status === 200) {
                        try {
                            const response = JSON.parse(this.responseText);
                            console.log("Parsed signup response:", response);
                            alert("Added task");

                            renderTasks("active");
                        } catch (e) {
                            console.error("Add Task: Could not parse JSON", e);
                        }
                    } else {
                        console.error("Failed to add task", this.status, this.responseText);
                    }
                }
            };
            xhttp.send(jsonData);
        });

        // -- EDIT TASK --
        $("#editTaskForm").on("submit", function(event) {
            event.preventDefault();

            // create javascript object storing the form data
            let formData = {};
                new FormData(this).forEach((value, key) => {
                    formData[key] = value;
            });

            console.log(formData);

            let jsonData = JSON.stringify(formData);
            console.log("Edited Task:", jsonData);

            const xhttp = new XMLHttpRequest();
            const url = "https://todo-list.dcism.org/editItem_action.php";

            xhttp.open('PUT', url, true);
            xhttp.onreadystatechange = function() {
                if (this.readyState === 4) {
                    console.log("Raw signup response:", this.responseText);
                    if (this.status === 200) {
                        try {
                            const response = JSON.parse(this.responseText);
                            console.log("Parsed signup response:", response);
                            alert("Edited task");

                            renderTasks("active");
                        } catch (e) {
                            console.error("Edit Task: Could not edit", e);
                        }
                        } else {
                            console.error("Failed to edit task", this.status, this.responseText);
                        }
                }
            }

            xhttp.send(jsonData);
        });

        // -- TOGGLE TASK STATUS -----
        $(document).on("click", ".toggle-status", function () {
            const taskId = $(this).data("id");
            const currentStatus = $(this).data("status");
            const newStatus = currentStatus === "active" ? "inactive" : "active";

            updateTaskStatus(taskId, newStatus);
        });

        function updateTaskStatus(itemId, newStatus) {
            let data = {
                status: newStatus,
                item_id: itemId
            };

            let jsonData = JSON.stringify(data);
            console.log(jsonData);

            var xhttp = new XMLHttpRequest();
            const url = "https://todo-list.dcism.org/statusItem_action.php";

            xhttp.open("PUT", url, true);

            xhttp.onreadystatechange = function () {
                console.log(this.readyState);
                if (this.readyState === 4) { 
                    console.log("Raw signup response:", this.responseText);
                    console.log(this.status);
                    if (this.status === 200) { 
                        try {
                            const response = JSON.parse(this.responseText);
                            console.log("Status updated:", response);
                            alert("✅ Task status changed to " + newStatus);

                            renderTasks("active");
                            renderTasks("inactive");
                        } catch (err) {
                            console.error("⚠️ Could not parse JSON:", this.responseText);
                            alert("Server did not return valid JSON.");
                        }
                    } else {
                        console.error("Failed to update status", this.status, this.responseText);
                        alert("Failed to update task status");
                    }   
                }
            }
            xhttp.send(jsonData);
        }

        // --- DELETE TASK -----------------
        
        $(document).on("click", ".delete-task", function () {
            let taskDiv = $(this).parent();  
            let taskId = taskDiv.attr('class');            
            console.log("Deleting task:", taskId);

            deleteTask(taskId);
        }); 

        function deleteTask(id) {
            var xhttp = new XMLHttpRequest();
            const url = `https://todo-list.dcism.org/deleteItem_action.php?item_id=${encodeURIComponent(id)}`;
            xhttp.open("GET", url, true);
            xhttp.send();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    console.log(response);

                    renderTasks("active");
                    renderTasks("inactive");
                }
            }
        }

        // -- RENDER TASK --------------------

        function renderTasks(status) {
            var xhttp = new XMLHttpRequest();
            const url = `https://todo-list.dcism.org/getItems_action.php?status=${encodeURIComponent(status)}&user_id=${encodeURIComponent(userId)}`; // Change
            xhttp.open("GET", url, true);
            xhttp.send();

            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    const response = JSON.parse(this.responseText);
                    console.log(response);
                    const items = Object.values(response.data || {}); // in case data is empty

                    console.log(items);

                    let todoDiv = document.querySelector(`.${status}-todo`);
                    let ul = document.createElement('ul');

                    todoDiv.innerHTML = '';

                    items.forEach(item => {
                        let task = document.createElement('div');
                        task.className = `${item.item_id}`
                        task.innerHTML = `
                            <h2>${item.item_name}</h2>
                            <p>${item.item_description}</p>
                            <button class="edit-task" data-id="${item.item_id}" data-name="${item.item_name}" data-desc="${item.item_description}">Edit</button>
                            <button class="toggle-status" data-id="${item.item_id}" data-status="${item.status}">${item.status === "active" ? "Mark Inactive" : "Mark Active"}</button>
                            <button class = "delete-task">Delete Task</button>
                        `;
                        ul.appendChild(task);
                    });

                    todoDiv.appendChild(ul);
                }
            }
        }

    </script>

</body>
</html>